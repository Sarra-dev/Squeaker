{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squeaker</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'assets/css/profile.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/share-menu.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/compact-posts.css' %}">
    
    <style>
        .emoji-picker-container {
            position: absolute;
            left: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: none;
            max-width: 320px;
            max-height: 350px;
            overflow-y: auto;
        }

        .emoji-picker-container.show {
            display: block;
        }

        .emoji-categories {
            display: flex;
            gap: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .emoji-category {
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .emoji-category.active {
            background: var(--primary-color);
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
        }

        .emoji-item {
            padding: 8px;
            font-size: 24px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            text-align: center;
            border: none;
            background: transparent;
        }

        .emoji-item:hover {
            background: var(--hover-bg);
        }

        /* ‚úÖ TOXICITY BLUR STYLES - ONLY ADDITION */
        .toxicity-warning {
            background: linear-gradient(135deg, rgba(255, 85, 85, 0.1) 0%, rgba(255, 0, 0, 0.05) 100%);
            border: 1px solid rgba(255, 85, 85, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .warning-content {
            display: flex;
            gap: 12px;
            align-items: start;
            flex: 1;
        }

        .warning-content i {
            color: #ff5555;
            font-size: 20px;
            margin-top: 2px;
        }

        .warning-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .warning-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .show-content-btn {
            background: transparent;
            border: 1px solid rgba(255, 85, 85, 0.5);
            color: #ff5555;
            padding: 6px 16px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .show-content-btn:hover {
            background: rgba(255, 85, 85, 0.1);
            border-color: #ff5555;
        }

        .blurred-content {
            filter: blur(8px)!important;
            user-select: none;
            pointer-events: none;
            transition: filter 0.3s ease;
        }

        .blurred-content.revealed {
            filter: blur(0)!important;
            user-select: text;
            pointer-events: auto;
        }

        /* Autocorrect button styling */
        .autocorrect-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white !important;
            border: none;
            transition: all 0.3s ease;
        }

        .autocorrect-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .autocorrect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spelling-indicator {
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(245, 166, 35, 0.1);
            border-left: 3px solid #f5a623;
            font-size: 12px;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Spell check icon animation */
        .fa-spell-check {
            animation: pulse 2s infinite;
        }

        .community-note {
    background: #f7f9f9;
    border: 1px solid #cfd9de;
    border-radius: 12px;
    padding: 12px;
    margin-top: 12px;
    font-size: 14px;
    animation: slideIn 0.3s ease;
}

    .community-note-header {
        display: flex;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
        color: #536471;
        font-size: 13px;
        font-weight: 600;
    }

    .community-note-header i {
        font-size: 16px;
    }

    .community-note-content {
        color: #0f1419;
        line-height: 1.5;
        margin-bottom: 8px;
    }

    .community-note-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #eff3f4;
        font-size: 12px;
        color: #536471;
    }

    .community-note-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }

    .badge-false {
        background: rgba(244, 67, 54, 0.15);
        color: #d32f2f;
    }

    .badge-unverifiable {
        background: rgba(255, 152, 0, 0.15);
        color: #e65100;
    }

    .badge-true {
        background: rgba(76, 175, 80, 0.15);
        color: #2e7d32;
    }

    .add-note-btn {
        background: transparent;
        border: 1px solid #cfd9de;
        color: #536471;
        padding: 4px 12px;
        border-radius: 16px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 8px;
    }

    .add-note-btn:hover {
        background: rgba(29, 155, 240, 0.1);
        border-color: #1d9bf0;
        color: #1d9bf0;
    }

    .add-note-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .add-note-btn i {
        margin-right: 4px;
    }

    .note-loading {
        color: #536471;
        font-size: 13px;
        font-style: italic;
        padding: 8px 0;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

    </style>
</head>

<body>
<div class="main-container">

    {% include 'navbar.html' %}

    <div class="main-content">

        <!-- HEADER -->
        <div class="content-header">
            <div class="header-content">
                <div class="header-title">
                    <div class="header-name">Home</div>
                </div>
            </div>
        </div>

        <!-- POST FORM -->
        {% if form %}
        <div class="post-form-container">
            <div class="post-form-header">

                {% if request.user.profile.profile_image %}
                    <img src="{{ request.user.profile.profile_image.url }}" class="post-form-avatar">
                {% else %}
                    <img src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png"
                         class="post-form-avatar">
                {% endif %}

                <form method="POST" enctype="multipart/form-data" class="post-form">
                    {% csrf_token %}

                    <!-- TEXT -->
                    <textarea name="{{ form.body.name }}"
                              id="post-textarea"
                              placeholder="What's happening?"
                              class="post-textarea"
                              maxlength="200"
                              rows="3">{{ form.body.value|default:'' }}</textarea>

                    <!-- IMAGE INPUT (hidden) -->
                    {{ form.image }}

                    <!-- PREVIEW CONTAINER -->
                    <div id="preview-container" style="display:none; position:relative; margin-top:10px;">
                        <img id="preview-img"
                             src="#"
                             style="max-width:100%; border-radius:12px;">
                        
                        <!-- Remove button -->
                        <button type="button" 
                                onclick="removePreviewImage()" 
                                style="position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.7); color:white; border:none; border-radius:50%; width:32px; height:32px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- ACTIONS -->
                    <div class="post-form-actions">
                        <div class="post-form-icons" style="position: relative;">
                            <button type="button" class="icon-btn" title="Photos"
                                    onclick="document.querySelector('input[name={{ form.image.name }}]').click();">
                                <i class="far fa-image"></i>
                            </button>

                            <button type="button" class="icon-btn" title="Emoji" onclick="toggleEmojiPicker()">
                                <i class="far fa-smile"></i>
                            </button>

                            <!-- Emoji Picker -->
                            <div id="emoji-picker" class="emoji-picker-container">
                                <div class="emoji-categories">
                                    <button class="emoji-category active" onclick="showEmojiCategory('smileys')">üòä</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('animals')">üê∂</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('food')">üçï</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('activities')">‚öΩ</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('travel')">‚úàÔ∏è</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('objects')">üí°</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('symbols')">‚ù§Ô∏è</button>
                                    <button class="emoji-category" onclick="showEmojiCategory('flags')">üè≥Ô∏è</button>
                                </div>
                                <div class="emoji-grid" id="emoji-grid"></div>
                                
                            </div>
                        </div>
                        
                        <button type="submit" class="btn-post">Post</button>
                    </div>
                </form>

            </div>
        </div>
        {% endif %}

        <!-- POSTS -->
        {% if meeps %}
            {% for meep in meeps %}
            <div class="post-card">
                <div class="post-header">

                    <a href="{% url 'profile' meep.user.pk %}">
                        {% if meep.user.profile.profile_image %}
                            <img src="{{ meep.user.profile.profile_image.url }}" class="post-avatar">
                        {% else %}
                            <img src="https://abs.twimg.com/sticky/default_profile_images/default_profile_400x400.png"
                                 class="post-avatar">
                        {% endif %}
                    </a>

                    <div class="post-content">

                        <!-- USER INFO -->
                        <div class="post-user-info">
                            <a href="{% url 'profile' meep.user.pk %}" class="post-username">
                                {{ meep.user.username }}
                            </a>

                            {% if meep.user.is_staff %}
                                <i class="fas fa-check-circle"
                                   style="color:var(--primary-color); font-size:14px;"></i>
                            {% endif %}

                            <span class="post-handle">@{{ meep.user.username }}</span>
                            <span class="post-date">{{ meep.created_at|timesince }}</span>
                        </div>

                        <!-- ‚úÖ TOXICITY WARNING & BLURRED TEXT - ONLY ADDITION -->
                        <!-- Replace the toxicity section (around line 280-310) with this: -->

{% if meep.should_blur %}
<div id="toxic-{{ meep.id }}">
    <!-- Warning Banner -->
    <div class="toxicity-warning" id="warning-{{ meep.id }}">
        <div class="warning-content">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <div class="warning-title">{{ meep.get_warning_message }}</div>
                <div class="warning-subtitle">
                    {% if meep.is_toxic %}
                        This content was flagged by our AI moderation system
                    {% else %}
                        Some people may find this content sensitive
                    {% endif %}
                </div>
            </div>
        </div>
        <button class="show-content-btn" onclick="showToxicContent('{{ meep.id }}')">
            Show anyway
        </button>
    </div>
    
    <!-- Blurred Content -->
    <div class="post-body blurred-content" id="content-{{ meep.id }}">
        {{ meep.body }}
    </div>
</div>
{% else %}
<!-- Normal Content -->
<div class="post-body">{{ meep.body }}</div>
{% endif %}

                        <!-- IMAGE -->
                        {% if meep.image %}
                            <img src="{{ meep.image.url }}"
                                 style="max-width:100%; border-radius:12px; margin-top:10px;">
                        {% endif %}

                        <!-- ==================== COMMUNITY NOTES ==================== -->
                        {% if meep.community_notes.all %}
                            {% for note in meep.community_notes.all %}
                                {% if note.is_active %}
                                <div class="community-note">
                                    <div class="community-note-header">
                                        <i class="fas {{ note.get_icon }}"></i>
                                        <span>Readers added context they thought people might want to know</span>
                                    </div>
                                    <div class="community-note-content">
                                        {{ note.explanation }}
                                    </div>
                                    <div class="community-note-footer">
                                        <div>
                                            <span class="community-note-badge badge-{{ note.get_css_class }}">
                                                {{ note.get_verdict_display }}
                                            </span>
                                            <span style="margin-left: 8px;">{{ note.created_at|date:"M d, Y" }}</span>
                                        </div>
                                        {% if user.is_staff %}
                                        <button onclick="removeNote({{ note.id }})" 
                                                style="background:none; border:none; color:#536471; cursor:pointer; font-size:12px;"
                                                title="Remove note">
                                            <i class="fas fa-times"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <!-- Button to add community note -->
                            <button class="add-note-btn" 
                                    onclick="addCommunityNote({{ meep.id }})" 
                                    id="note-btn-{{ meep.id }}">
                                <i class="fas fa-plus"></i> Add context
                            </button>
                            <div id="note-loading-{{ meep.id }}" class="note-loading" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i> Analyzing post...
                            </div>
                        {% endif %}

                        <!-- ACTION BUTTONS -->
                        <div class="post-actions">

                            <!-- COMMENTS -->
                            <a href="{% url 'meep_show' pk=meep.id %}" class="action-button">
                                <i class="far fa-comment"></i>
                                <span>{{ meep.comments.count }}</span>
                            </a>

                          

                            <!-- LIKE -->
                            {% if user in meep.likes.all %}
                                <form method="post" action="{% url 'meep_like' meep.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button like liked">
                                        <i class="fas fa-heart"></i>
                                        <span>{{ meep.number_of_likes }}</span>
                                    </button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'meep_like' meep.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button like">
                                        <i class="far fa-heart"></i>
                                        <span>{{ meep.number_of_likes }}</span>
                                    </button>
                                </form>
                            {% endif %}

                           
                           

                            <!-- SHARE -->
                            {% if user in meep.shares.all %}
                                <form method="post" action="{% url 'meep_share' meep.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button like shared">
                                        <i class="fas fa-share" style="color: var(--primary-color);"></i>
                                        <span>{{ meep.shares.count }}</span>
                                    </button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'meep_share' meep.id %}" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="action-button">
                                        <i class="fa-solid fa-share" style="color:gray"></i>
                                        <span>{{ meep.shares.count }}</span>
                                    </button>
                                </form>
                            {% endif %}

                        </div>

                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="far fa-comment"></i>
                <h3>No posts yet</h3>
                <p>When people post, they'll appear here.</p>
            </div>
        {% endif %}

    </div>

    {% include 'trending.html' %}
</div>

<script src="{% static 'assets/js/share-menu.js' %}"></script>
<script>
// ‚úÖ TOXICITY BLUR FUNCTION - ONLY ADDITION
function showToxicContent(meepId) {
    const content = document.getElementById(`content-${meepId}`);
    const warning = document.getElementById(`warning-${meepId}`);
    
    if (content) {
        content.classList.add('revealed');
    }
    
    if (warning) {
        warning.style.display = 'none';
    }
}


let autocorrectTimeout;
const textarea = document.getElementById('post-textarea');

// Create autocorrect button
const autocorrectBtn = document.createElement('button');
autocorrectBtn.type = 'button';
autocorrectBtn.className = 'icon-btn autocorrect-btn';
autocorrectBtn.title = 'Auto-correct spelling (AI-powered)';
autocorrectBtn.innerHTML = '<i class="fas fa-spell-check"></i>';

// Add button to icons container (first position)
const iconsContainer = document.querySelector('.post-form-icons');
if (iconsContainer) {
    iconsContainer.insertBefore(autocorrectBtn, iconsContainer.firstChild);
}

// Spelling error indicator
const errorIndicator = document.createElement('div');
errorIndicator.className = 'spelling-indicator';
errorIndicator.style.display = 'none';
textarea.parentElement.appendChild(errorIndicator);

        // Real-time spell checking (debounced)
        textarea.addEventListener('input', function() {
            clearTimeout(autocorrectTimeout);
            
            autocorrectTimeout = setTimeout(async () => {
                const text = textarea.value.trim();
                
                if (text.length < 3) {
                    errorIndicator.style.display = 'none';
                    return;
                }
                
                try {
                    const response = await fetch('/api/check-spelling/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ text: text })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.has_errors) {
                        const errorCount = data.error_count || 0;
                        errorIndicator.innerHTML = `
                            <i class="fas fa-exclamation-circle"></i>
                            ${errorCount} spelling ${errorCount === 1 ? 'error' : 'errors'} detected
                            <button onclick="triggerAutocorrect()" style="margin-left:10px; padding:2px 8px; background:transparent; border:1px solid #f5a623; border-radius:4px; color:#f5a623; font-size:11px; cursor:pointer;">
                                Auto-correct
                            </button>
                        `;
                        errorIndicator.style.display = 'flex';
                        errorIndicator.style.alignItems = 'center';
                        errorIndicator.style.gap = '8px';
                        errorIndicator.style.color = '#f5a623';
                        errorIndicator.style.fontSize = '13px';
                        errorIndicator.style.padding = '8px 12px';
                        errorIndicator.style.background = 'rgba(245, 166, 35, 0.1)';
                        errorIndicator.style.borderLeft = '3px solid #f5a623';
                        errorIndicator.style.borderRadius = '6px';
                        errorIndicator.style.marginTop = '8px';
                    } else {
                        errorIndicator.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Spell check error:', error);
                    errorIndicator.style.display = 'none';
                }
            }, 1000); // Reduced to 1 second for better UX
        });


        // Helper function to trigger autocorrect
        function triggerAutocorrect() {
            autocorrectBtn.click();
        }


        // Autocorrect button click handler
        autocorrectBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const text = textarea.value.trim();
            
            if (!text) {
                showNotification('‚ö†Ô∏è Please enter some text first', 'warning');
                return;
            }
            
            // Show loading state
            autocorrectBtn.disabled = true;
            autocorrectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            errorIndicator.innerHTML = `
                <i class="fas fa-cog fa-spin"></i>
                Analyzing and correcting text...
            `;
            errorIndicator.style.display = 'flex';
            errorIndicator.style.color = '#667eea';
            errorIndicator.style.background = 'rgba(102, 126, 234, 0.1)';
            errorIndicator.style.borderLeft = '3px solid #667eea';
            
            try {
                const response = await fetch('/api/autocorrect/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ 
                        text: text,
                        advanced: true // Enable advanced correction
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const originalText = data.original_text;
                    const correctedText = data.corrected_text;
                    const errorCount = data.error_count || 0;
                    
                    if (data.changes_made && originalText !== correctedText) {
                        // Text was corrected - apply it
                        textarea.value = correctedText;
                        
                        // Show success message with corrections count
                        errorIndicator.innerHTML = `
                            <i class="fas fa-check-circle"></i>
                            Text corrected! Fixed ${errorCount} ${errorCount === 1 ? 'error' : 'errors'}
                        `;
                        errorIndicator.style.color = '#4caf50';
                        errorIndicator.style.background = 'rgba(76, 175, 80, 0.1)';
                        errorIndicator.style.borderLeft = '3px solid #4caf50';
                        errorIndicator.style.display = 'flex';
                        
                        // Show notification
                        showNotification(`‚úÖ ${data.message}`, 'success');
                        
                        // Hide after 3 seconds
                        setTimeout(() => {
                            errorIndicator.style.display = 'none';
                        }, 3000);
                        
                    } else {
                        // No errors found
                        errorIndicator.innerHTML = `
                            <i class="fas fa-check-circle"></i>
                            No spelling errors found! Text looks good.
                        `;
                        errorIndicator.style.color = '#4caf50';
                        errorIndicator.style.background = 'rgba(76, 175, 80, 0.1)';
                        errorIndicator.style.borderLeft = '3px solid #4caf50';
                        errorIndicator.style.display = 'flex';
                        
                        showNotification('‚úÖ No spelling errors detected', 'success');
                        
                        setTimeout(() => {
                            errorIndicator.style.display = 'none';
                        }, 3000);
                    }
                    
                    // Show detailed errors if any
                    if (data.errors && Object.keys(data.errors).length > 0) {
                        console.log('Spelling errors found:', data.errors);
                    }
                    
                } else {
                    // Error occurred
                    showNotification('‚ùå ' + (data.message || data.error || 'Failed to autocorrect'), 'error');
                    errorIndicator.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Autocorrect error:', error);
                showNotification('‚ùå Network error. Please try again.', 'error');
                errorIndicator.style.display = 'none';
            } finally {
                // Restore button state
                autocorrectBtn.disabled = false;
                autocorrectBtn.innerHTML = '<i class="fas fa-spell-check"></i>';
            }
        });

        // Helper: Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Helper: Show notification toast
        function showNotification(message, type = 'info') {
            // Remove existing notification
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            // Create notification
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.textContent = message;
            
            // Style
            Object.assign(toast.style, {
                position: 'fixed',
                top: '20px',
                right: '20px',
                padding: '12px 20px',
                borderRadius: '8px',
                fontWeight: '600',
                fontSize: '14px',
                zIndex: '10000',
                animation: 'slideInRight 0.3s ease',
                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
                maxWidth: '300px'
            });
            
            // Color based on type
            if (type === 'success') {
                toast.style.background = '#4caf50';
                toast.style.color = 'white';
            } else if (type === 'error') {
                toast.style.background = '#f44336';
                toast.style.color = 'white';
            } else if (type === 'warning') {
                toast.style.background = '#ff9800';
                toast.style.color = 'white';
            } else {
                toast.style.background = '#2196F3';
                toast.style.color = 'white';
            }
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        `;
        document.head.appendChild(style);


// Emoji data
const emojiData = {
    smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'ü•≤', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'üò∂‚Äçüå´Ô∏è', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé'],
    animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à'],
    food: ['üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü•ù', 'üçÖ', 'ü••', 'ü•ë', 'üçÜ', 'ü•î', 'ü•ï', 'üåΩ', 'üå∂Ô∏è', 'ü•í', 'ü•¨', 'ü•¶', 'üßÑ', 'üßÖ', 'üçÑ', 'ü•ú', 'üå∞', 'üçû', 'ü•ê', 'ü•ñ', 'ü•®', 'ü•Ø', 'ü•û', 'üßá', 'üßÄ', 'üçñ', 'üçó', 'ü•©', 'ü•ì', 'üçî', 'üçü', 'üçï', 'üå≠', 'ü•™', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ', 'ü•ö', 'üç≥', 'ü•ò', 'üç≤', 'ü•£', 'ü•ó', 'üçø', 'üßà'],
    activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü™É', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõº', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è', 'ü§º', 'ü§∏', '‚õπÔ∏è', 'ü§∫', 'ü§æ', 'üèåÔ∏è', 'üèá', 'üßò', 'üèä', 'üö¥', 'üöµ', 'üé™', 'üé≠', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üé∏'],
    travel: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üõª', 'üöö', 'üöõ', 'üöú', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ', 'üèçÔ∏è', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°', 'üö†', 'üöü', 'üöÉ', 'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 'üöä', 'üöâ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ∂', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', '‚õΩ'],
    objects: ['‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è', 'üóúÔ∏è', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°', 'üîã', 'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è'],
    symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è'],
    flags: ['üèÅ', 'üö©', 'üéå', 'üè¥', 'üè≥Ô∏è', 'üè≥Ô∏è‚Äçüåà', 'üè≥Ô∏è‚Äç‚ößÔ∏è', 'üè¥‚Äç‚ò†Ô∏è', 'üá¶üá´', 'üá¶üáΩ', 'üá¶üá±', 'üá©üáø', 'üá¶üá∏', 'üá¶üá©', 'üá¶üá¥', 'üá¶üáÆ', 'üá¶üá∂', 'üá¶üá¨', 'üá¶üá∑', 'üá¶üá≤', 'üá¶üáº', 'üá¶üá∫', 'üá¶üáπ', 'üá¶üáø', 'üáßüá∏', 'üáßüá≠', 'üáßüá©', 'üáßüáß', 'üáßüáæ', 'üáßüá™', 'üáßüáø', 'üáßüáØ', 'üáßüá≤', 'üáßüáπ', 'üáßüá¥', 'üáßüá¶', 'üáßüáº', 'üáßüá∑', 'üáÆüá¥', 'üáªüá¨', 'üáßüá≥', 'üáßüá¨', 'üáßüá´', 'üáßüáÆ', 'üá∞üá≠', 'üá®üá≤', 'üá®üá¶', 'üáÆüá®', 'üá®üáª', 'üáßüá∂', 'üá∞üáæ', 'üá®üá´', 'üáπüá©', 'üá®üá±', 'üá®üá≥', 'üá®üáΩ', 'üá®üá®']
};

let currentCategory = 'smileys';

// Toggle emoji picker
function toggleEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.classList.toggle('show');
    if (picker.classList.contains('show')) {
        showEmojiCategory('smileys');
    }
}

// Show emoji category
function showEmojiCategory(category) {
    currentCategory = category;
    const grid = document.getElementById('emoji-grid');
    grid.innerHTML = '';
    
    // Update active category button
    document.querySelectorAll('.emoji-category').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Add emojis to grid
    emojiData[category].forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-item';
        btn.textContent = emoji;
        btn.type = 'button';
        btn.onclick = () => insertEmoji(emoji);
        grid.appendChild(btn);
    });
}

// Insert emoji at cursor position
function insertEmoji(emoji) {
    const textarea = document.getElementById('post-textarea');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    
    // Close picker
    document.getElementById('emoji-picker').classList.remove('show');
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(event) {
    const picker = document.getElementById('emoji-picker');
    const emojiBtn = event.target.closest('.icon-btn[title="Emoji"]');
    
    if (!picker.contains(event.target) && !emojiBtn) {
        picker.classList.remove('show');
    }
});

// Image preview functionality
document.addEventListener('DOMContentLoaded', function() {
    const imageInput = document.querySelector('input[type="file"]');
    const previewImg = document.getElementById('preview-img');
    const previewContainer = document.getElementById('preview-container');
    
    if (imageInput && previewImg && previewContainer) {
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        previewContainer.style.display = 'block';
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select an image file');
                    imageInput.value = '';
                }
            }
        });
    }
});

// Remove image preview
function removePreviewImage() {
    const previewContainer = document.getElementById('preview-container');
    const imageInput = document.querySelector('input[type="file"]');
    
    if (previewContainer) {
        previewContainer.style.display = 'none';
    }
    
    if (imageInput) {
        imageInput.value = '';
    }
}

// üëá ADD THESE 3 FUNCTIONS AT THE END OF YOUR <script> TAG (after removePreviewImage function) üëá

// Function 1: Check facts when button is clicked
async function checkFacts() {
    const textarea = document.getElementById('post-textarea');
    const content = textarea.value.trim();
    const button = document.getElementById('factCheckBtn');
    const container = document.getElementById('fact-check-container');
    
    if (!content) {
        showNotification('‚ö†Ô∏è Please write something before fact-checking!', 'warning');
        return;
    }
    
    // Show loading spinner
    button.disabled = true;
    container.innerHTML = `
        <div class="fact-check-loading">
            <i class="fas fa-spinner"></i>
            <span>Analyzing post for factual accuracy...</span>
        </div>
    `;
    
    try {
        const csrftoken = getCookie('csrftoken');
        
        // Call our backend API
        const response = await fetch('/api/fact-check/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ content: content })
        });
        
        if (!response.ok) {
            throw new Error('Fact-check failed');
        }
        
        const data = await response.json();
        
        if (data.success) {
            displayFactCheckResult(data.result);
        } else {
            throw new Error(data.error || 'Unknown error');
        }
        
    } catch (error) {
        console.error('Fact check error:', error);
        container.innerHTML = `
            <div class="fact-check-result false">
                <div class="fact-check-header">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error</span>
                </div>
                <div class="fact-check-explanation">
                    Unable to fact-check at this time. Please try again.
                </div>
            </div>
        `;
    } finally {
        button.disabled = false;
    }
}

// Function 2: Display the results in a nice colored box
function displayFactCheckResult(result) {
    const container = document.getElementById('fact-check-container');
    const verdict = result.verdict.toLowerCase();
    
    const icons = {
        'true': 'fa-check-circle',
        'false': 'fa-times-circle',
        'unverifiable': 'fa-question-circle',
        'opinion': 'fa-comment-dots'
    };
    
    const titles = {
        'true': 'Factually Accurate',
        'false': 'Contains Misinformation',
        'unverifiable': 'Cannot Verify',
        'opinion': 'Opinion/Subjective'
    };
    
    const confidenceClass = `confidence-${result.confidence.toLowerCase()}`;
    
    container.innerHTML = `
        <div class="fact-check-result ${verdict}">
            <div class="fact-check-header">
                <i class="fas ${icons[verdict]}"></i>
                <span>${titles[verdict]}</span>
                <span class="fact-check-confidence ${confidenceClass}">${result.confidence}</span>
            </div>
            <div class="fact-check-explanation">${result.explanation}</div>
            ${result.reasoning ? `<div class="fact-check-reasoning">${result.reasoning}</div>` : ''}
        </div>
    `;
}

// ==================== COMMUNITY NOTES FUNCTIONS ====================

// Add community note to a post
async function addCommunityNote(meepId) {
    const button = document.getElementById(`note-btn-${meepId}`);
    const loading = document.getElementById(`note-loading-${meepId}`);
    
    if (!button) return;
    
    // Show loading
    button.style.display = 'none';
    loading.style.display = 'block';
    
    try {
        const csrftoken = getCookie('csrftoken');
        
        const response = await fetch(`/api/community-note/${meepId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (data.no_note_needed) {
                // No note needed
                loading.innerHTML = '<i class="fas fa-check-circle"></i> No context needed - post appears accurate';
                loading.style.color = '#4caf50';
                setTimeout(() => {
                    loading.style.display = 'none';
                    button.style.display = 'inline-block';
                }, 3000);
            } else {
                // Note added - reload page to show it
                loading.innerHTML = '<i class="fas fa-check-circle"></i> Context added! Reloading...';
                loading.style.color = '#1d9bf0';
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            throw new Error(data.error || 'Failed to add note');
        }
        
    } catch (error) {
        console.error('Community note error:', error);
        loading.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to add context';
        loading.style.color = '#f44336';
        setTimeout(() => {
            loading.style.display = 'none';
            button.style.display = 'inline-block';
        }, 3000);
    }
}

// Remove community note (staff only)
async function removeNote(noteId) {
    if (!confirm('Remove this community note?')) return;
    
    try {
        const csrftoken = getCookie('csrftoken');
        
        const response = await fetch(`/api/community-note/${noteId}/remove/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('‚úÖ Community note removed', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification('‚ùå Failed to remove note', 'error');
        }
        
    } catch (error) {
        console.error('Remove note error:', error);
        showNotification('‚ùå Error removing note', 'error');
    }
}

// Note: getCookie function already exists in your file, so no need to add it again!
</script>
</body>
</html>